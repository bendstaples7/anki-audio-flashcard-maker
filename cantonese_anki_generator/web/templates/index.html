<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantonese Anki Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- 
        WaveSurfer.js library loaded from CDN
        TODO: For production use, either:
        1. Download and serve locally from static folder, OR
        2. Generate proper SRI hashes using: openssl dgst -sha384 -binary file.js | openssl base64 -A
        Current placeholder hashes should be replaced with actual hashes from the CDN files
    -->
    <script src="https://unpkg.com/wavesurfer.js@7.7.3/dist/wavesurfer.min.js" 
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/wavesurfer.js@7.7.3/dist/plugins/regions.min.js" 
            crossorigin="anonymous"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Cantonese Anki Generator</h1>
            <p>Create vocabulary flashcards with audio for Cantonese learning</p>
        </header>
        
        <main>
            <!-- Mode Selection Section -->
            <section id="mode-selection" class="card">
                <h2>Choose Your Workflow</h2>
                <p class="section-description">Select how you want to create your Anki deck</p>
                
                <div class="mode-options">
                    <button id="prepare-mode-btn" class="mode-option-btn">
                        <span class="mode-icon">üìù</span>
                        <h3>Prepare Spreadsheet</h3>
                        <p>Start with English terms and automatically generate Cantonese translations and Jyutping romanization</p>
                        <span class="mode-badge">New</span>
                    </button>
                    
                    <button id="upload-mode-btn" class="mode-option-btn">
                        <span class="mode-icon">üéµ</span>
                        <h3>Link Spreadsheet + Upload Audio</h3>
                        <p>Use an existing Google Sheets vocabulary list and align it with audio recordings</p>
                        <span class="mode-badge">Standard</span>
                    </button>
                </div>
            </section>
            
            <!-- Spreadsheet Preparation Interface -->
            <section id="spreadsheet-prep-section" class="card" style="display: none;">
                <h2>Prepare Vocabulary Spreadsheet</h2>
                <p class="section-description">Enter English terms to automatically generate Cantonese translations and Jyutping romanization</p>
                
                <!-- Input Interface -->
                <div class="prep-input-container">
                    <div class="form-group">
                        <label for="english-terms-input">
                            <span class="label-text">English Terms</span>
                            <span class="label-hint">Enter one term per line (e.g., hello, goodbye, thank you)</span>
                        </label>
                        <textarea 
                            id="english-terms-input" 
                            class="english-terms-textarea"
                            placeholder="Enter English terms, one per line:&#10;&#10;hello&#10;goodbye&#10;thank you&#10;good morning&#10;how are you"
                            rows="10"
                        ></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button id="generate-translations-btn" class="btn btn-primary" disabled>
                            <span class="btn-icon">‚ú®</span>
                            Generate Translations
                        </button>
                    </div>
                </div>
                
                <!-- Progress Indicator -->
                <div id="translation-progress" class="translation-progress" style="display: none;">
                    <div class="progress-header">
                        <h3>Generating Translations</h3>
                        <p class="progress-description">Please wait while we translate your terms...</p>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="translation-progress-fill"></div>
                        </div>
                        <div class="progress-percentage" id="translation-progress-percentage">0%</div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total:</span>
                            <span class="stat-value" id="progress-total">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Completed:</span>
                            <span class="stat-value" id="progress-completed">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Failed:</span>
                            <span class="stat-value" id="progress-failed">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Error Display Area -->
                <div id="prep-error-display" class="prep-error-display" style="display: none;">
                    <div class="error-display-header">
                        <span class="error-display-icon">‚ö†Ô∏è</span>
                        <h4 class="error-display-title">Error</h4>
                        <button class="error-display-close" onclick="hidePrepError()">√ó</button>
                    </div>
                    <div class="error-display-message" id="prep-error-message"></div>
                    <div class="error-display-actions" id="prep-error-actions" style="display: none;">
                        <h5>Suggested Actions:</h5>
                        <ul id="prep-error-actions-list"></ul>
                    </div>
                </div>
                
                <!-- Review Table -->
                <div id="review-table-container" class="review-table-container" style="display: none;">
                    <div class="review-table-header">
                        <h3>Review and Edit Translations</h3>
                        <p class="review-description">Review the generated translations and make any necessary edits. Entries with errors are highlighted.</p>
                    </div>
                    
                    <div class="review-table-wrapper">
                        <table id="review-table" class="review-table">
                            <thead>
                                <tr>
                                    <th class="col-english">English</th>
                                    <th class="col-cantonese">Cantonese</th>
                                    <th class="col-jyutping">Jyutping</th>
                                    <th class="col-status">Status</th>
                                </tr>
                            </thead>
                            <tbody id="review-table-body">
                                <!-- Rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="review-table-actions">
                        <button id="export-sheet-btn" class="btn btn-success" disabled>
                            <span class="btn-icon">üìä</span>
                            Generate Google Sheet
                        </button>
                        <div id="export-result" class="export-result" style="display: none;"></div>
                    </div>
                </div>
            </section>
            
            <!-- Two Column Layout: Upload Form + Processing Log -->
            <div class="upload-container" style="display: none;">
                <!-- Left Column: File Upload Section -->
                <section id="upload-section" class="card upload-card">
                    <h2>Upload Files</h2>
                    <p class="section-description">Upload your vocabulary document and audio file to begin</p>
                    
                    <form id="upload-form" class="upload-form">
                        <div class="form-group">
                            <label for="doc-url">
                                <span class="label-text">Google Docs/Sheets URL</span>
                                <span class="label-hint">Paste the URL of your vocabulary document</span>
                            </label>
                            <input 
                                type="url" 
                                id="doc-url" 
                                name="doc-url" 
                                placeholder="https://docs.google.com/..." 
                                required
                            >
                            <div class="validation-feedback" id="url-feedback"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="audio-file">
                                <span class="label-text">Audio File</span>
                                <span class="label-hint">Select an MP3, WAV, or M4A file</span>
                            </label>
                            <div class="file-input-wrapper">
                                <input 
                                    type="file" 
                                    id="audio-file" 
                                    name="audio-file" 
                                    accept=".mp3,.wav,.m4a,audio/mpeg,audio/wav,audio/x-m4a" 
                                    required
                                >
                                <div class="file-input-display">
                                    <span class="file-icon">üìÅ</span>
                                    <span class="file-name">No file selected</span>
                                </div>
                            </div>
                            <div class="validation-feedback" id="file-feedback"></div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" id="process-btn" class="btn btn-primary" disabled>
                                <span class="btn-icon">‚öôÔ∏è</span>
                                Process
                            </button>
                            <div class="upload-progress" id="upload-progress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                                <span class="progress-text" id="progress-text">Uploading...</span>
                            </div>
                        </div>
                    </form>
                </section>
                
                <!-- Right Column: Processing Log Panel -->
                <section id="processing-log-section" class="card log-card">
                    <h2>Processing Log</h2>
                    <p class="section-description">Real-time verification and alignment progress</p>
                    
                    <div id="processing-log" class="processing-log">
                        <div class="log-placeholder">
                            <span class="log-icon">üìã</span>
                            <p>Processing logs will appear here when you upload files</p>
                        </div>
                    </div>
                    
                    <div class="log-controls">
                        <button id="clear-log-btn" class="btn btn-secondary btn-sm" disabled>
                            Clear Log
                        </button>
                        <button id="copy-log-btn" class="btn btn-secondary btn-sm" disabled>
                            Copy to Clipboard
                        </button>
                    </div>
                </section>
            </div>
            
            <!-- Alignment Review Section -->
            <section id="alignment-section" class="card" style="display: none;">
                <div class="section-header">
                    <div class="header-left">
                        <button id="back-btn" class="btn btn-secondary">
                            <span class="btn-icon">‚Üê</span>
                            Back to Upload
                        </button>
                        <h2>Alignment Review</h2>
                    </div>
                    <div class="control-buttons">
                        <button id="save-btn" class="btn btn-secondary">
                            <span class="btn-icon">üíæ</span>
                            Save Progress
                        </button>
                        <button id="reset-all-btn" class="btn btn-warning">
                            <span class="btn-icon">‚Ü∫</span>
                            Reset All
                        </button>
                        <button id="generate-btn" class="btn btn-success">
                            <span class="btn-icon">üì¶</span>
                            Generate Anki Deck
                        </button>
                    </div>
                </div>
                
                <!-- Full Waveform Overview -->
                <div id="full-waveform-container" class="waveform-overview">
                    <h3>Full Audio Overview</h3>
                    <div class="waveform-controls">
                        <div class="zoom-controls">
                            <button id="zoom-out-btn" class="btn btn-icon" title="Zoom Out">‚àí</button>
                            <input type="range" id="zoom-slider" min="1" max="100" value="1" class="zoom-slider">
                            <button id="zoom-in-btn" class="btn btn-icon" title="Zoom In">+</button>
                        </div>
                        <div class="zoom-info">
                            <span id="zoom-level">Zoom: 1x</span>
                            <span id="time-range">0:00 - 0:00</span>
                        </div>
                    </div>
                    <div id="full-waveform" class="waveform-display"></div>
                </div>
                
                <!-- Alignment Table -->
                <div id="alignment-table-container" class="alignment-table-wrapper">
                    <div class="table-controls">
                        <h3>Term Alignments</h3>
                        <div class="filter-controls">
                            <label>
                                <input type="checkbox" id="show-low-confidence">
                                Show only low confidence
                            </label>
                            <select id="sort-by">
                                <option value="order">Original order</option>
                                <option value="confidence">Confidence (low first)</option>
                                <option value="adjusted">Manually adjusted</option>
                            </select>
                            <button id="quality-help-btn" class="btn btn-icon" title="About quality indicators">?</button>
                        </div>
                    </div>
                    
                    <!-- Quality Indicator Help Panel -->
                    <div id="quality-help-panel" class="help-panel" style="display: none;">
                        <div class="help-panel-header">
                            <h4>Understanding Quality Indicators</h4>
                            <button id="close-help-btn" class="btn btn-icon">√ó</button>
                        </div>
                        <div class="help-panel-content">
                            <p>Quality indicators show how confident the automatic alignment system is about each term's boundaries.</p>
                            
                            <div class="help-indicator-examples">
                                <div class="help-indicator-item">
                                    <div class="quality-indicator high">‚úì</div>
                                    <div class="help-indicator-text">
                                        <strong>High Confidence (80-100%)</strong>
                                        <p>The automatic alignment is likely accurate. These terms typically have clear audio boundaries and good voice activity detection.</p>
                                    </div>
                                </div>
                                
                                <div class="help-indicator-item">
                                    <div class="quality-indicator medium">‚ö†</div>
                                    <div class="help-indicator-text">
                                        <strong>Medium Confidence (60-79%)</strong>
                                        <p>The alignment may need review. Consider listening to verify the boundaries are correct.</p>
                                    </div>
                                </div>
                                
                                <div class="help-indicator-item">
                                    <div class="quality-indicator low">‚úó</div>
                                    <div class="help-indicator-text">
                                        <strong>Low Confidence (0-59%)</strong>
                                        <p>Manual adjustment recommended. These terms may have unclear boundaries, background noise, or overlapping speech.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="help-tips">
                                <h5>Tips:</h5>
                                <ul>
                                    <li>Use the "Show only low confidence" filter to focus on terms that need attention</li>
                                    <li>Sort by "Confidence (low first)" to review problematic terms first</li>
                                    <li>Listen to each term and adjust boundaries as needed using the draggable markers</li>
                                    <li>Low confidence doesn't always mean incorrect - verify by listening</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alignment-table">
                        <div class="table-header">
                            <div class="col-term">Term</div>
                            <div class="col-waveform">Waveform</div>
                            <div class="col-controls">Controls</div>
                            <div class="col-quality">Quality</div>
                        </div>
                        <div id="alignment-rows" class="table-body">
                            <!-- Term rows will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Generation Progress Section -->
            <section id="generation-section" class="card" style="display: none;">
                <h2>Generating Anki Deck</h2>
                <div class="generation-progress">
                    <div class="progress-bar large">
                        <div class="progress-fill" id="generation-progress-fill"></div>
                    </div>
                    <p class="progress-text" id="generation-status">Preparing...</p>
                    <div class="generation-details" id="generation-details"></div>
                </div>
            </section>
            
            <!-- Generation Complete Section -->
            <section id="complete-section" class="card" style="display: none;">
                <h2>‚úì Generation Complete</h2>
                <div class="completion-summary">
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-label">Total Terms</span>
                            <span class="stat-value" id="total-terms">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Manually Adjusted</span>
                            <span class="stat-value" id="adjusted-terms">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">File Size</span>
                            <span class="stat-value" id="file-size">0 MB</span>
                        </div>
                    </div>
                    <div class="download-section">
                        <button id="download-btn" class="btn btn-primary btn-large">
                            <span class="btn-icon">‚¨áÔ∏è</span>
                            Download Anki Deck
                        </button>
                        <p class="download-hint">Your .apkg file is ready to import into Anki</p>
                    </div>
                    <div class="adjusted-terms-list" id="adjusted-terms-list"></div>
                </div>
            </section>
        </main>
        
        <!-- Error Toast -->
        <div id="error-toast" class="toast toast-error" style="display: none;">
            <span class="toast-icon">‚ö†Ô∏è</span>
            <span class="toast-message" id="error-message"></span>
            <button class="toast-close" onclick="hideError()">√ó</button>
        </div>
        
        <!-- Success Toast -->
        <div id="success-toast" class="toast toast-success" style="display: none;">
            <span class="toast-icon">‚úì</span>
            <span class="toast-message" id="success-message"></span>
            <button class="toast-close" onclick="hideSuccess()">√ó</button>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
